---
title: VIMS resazurin trials  
author: "AS Huffmyer"
date: '2025'
output:
  github_document: null
  md_document: default
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 6
    toc_float: true
editor_options: 
  chunk_output_type: console
---

This script analyzes resazurin assays conducted at VIMS.  

Things we want to calculate: 

- Inter and intra family variability in metabolism 
- Temperature phases of metabolism 
- Correlation with traits 
- End point total fluorescence 

# Set up 

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries. 
```{r}
library(MASS) 
library(tidyverse)
library(ggplot2)
library(readxl)
library(cowplot)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(emmeans)
library(tools)
```

# Resazurin Trials   

## Load data 

```{r}
# Set the folder path
folder_path <- "data/plate-files/"  

# List all txt files in the folder
file_list <- list.files(path = folder_path, pattern = "\\.xlsx$", full.names = TRUE, recursive=TRUE)

file_list <- file_list[!grepl("20250630", file_list)]

# Check if any files are found
if (length(file_list) == 0) {
  stop("No xlsx files found in the specified folder. Check the folder path or file extension.")
}

# Initialize an empty list to store processed data
data_list <- list()

# Loop through each file and load the data
for (file in file_list) {
  # Ensure file is a character string
  if (!is.character(file)) next
  
  # Extract file name without extension
  file_name <- file_path_sans_ext(basename(file))
  
  # Read Excel file, skipping the first 9 rows
  data <- read_excel(file, skip = 10, col_names = FALSE)

  # Keep only the first 16 rows (row 1–16 after - skip)
  data <- data[1:4, ]
  
  # Assign column names: first column is row labels (A–H), others are 1–12
  colnames(data) <- c("Row", as.character(1:13))
  
  #remove first column
  #data<-data%>%select(!"Row")
  
  # Convert to long format
  data_long <- data %>%
    pivot_longer(cols = -Row, names_to = "Column", values_to = "Value") %>%
    mutate(
      Column = sprintf("%02d", as.integer(Column)),  # Ensure two-digit column numbers
      Well_ID = paste0(Row, Column),                # Format well ID as "A01", "B02", etc.
      FileName = file_name,                          # Add file name
      plate = str_extract(file_name, "plate\\d+"),  # Extract "plateX"
      date = str_extract(file_name, "^\\d{8}"),     # Extract 8-digit date
      timepoint = str_extract(file_name, "T\\d+") %>% 
        str_remove("T") %>% 
        as.numeric()                                # Convert timepoint to numeric
    ) %>%
    select(FileName, Well_ID, Value, date, plate, timepoint)  # Select relevant columns
  
  # Store the processed data in the list
  data_list[[file_name]] <- data_long
}

# Print an example of processed data
head(data_list[[file_name]])


# Combine all data frames into a single data frame (optional)
combined_data <- bind_rows(data_list, .id = "Source")

# Print the first few rows of the combined data (optional)
head(combined_data)

# Rename columns
combined_data<-combined_data%>%
  rename("well"=Well_ID, resazurin_counts=`Value`)%>%
  mutate(timepoint=as.character(timepoint))

head(combined_data)
```

Load in metadata. 

```{r}
metadata<-read_xlsx(path="data/trial_metadata.xlsx")%>%
  mutate(date=as.character(date))
```

Join with data frame and remove any wells that did not have samples. 

```{r}
str(combined_data)
str(metadata)

full_data<-left_join(combined_data, metadata, by=c("date", "well", "plate"))%>%
  filter(!is.na(type))

head(full_data)
```

Load in size data. 

```{r}
size<-read_xlsx("data/size/trial_size.xlsx")%>%
  mutate(date=as.character(date))
```

Join with data. 

```{r}
str(full_data)
str(size)

full_data<-left_join(full_data, size, by=c("date", "plate", "well"))
head(full_data)

full_data<-full_data%>%
  select(!Source)%>%
  select(!FileName)%>%
  select(!notes)

head(full_data)
```

## Prep the data 

Plot the raw data. 

```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=resazurin_counts, colour=family, group=interaction(date, plate, well)))+
  facet_wrap(~date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Calculate size normalized fluorescence at each time point normalized to the starting value at time 0. 
```{r}
full_data<-full_data%>%
  group_by(date, plate, well, family)%>%
  arrange(date, plate, well)%>%
  mutate(fluorescence.norm=resazurin_counts/first(resazurin_counts))
```

Plot again. 

```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=fluorescence.norm, colour=family, group=interaction(date, plate, well)))+
  facet_wrap(~date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

View blanks

```{r}
full_data%>%
  filter(type=="blank")%>%
  ggplot(aes(x=timepoint, y=fluorescence.norm, colour = temperature, group=interaction(date, plate, well)))+
  facet_wrap(~date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Calculate mean change in blank at each time point. 

```{r}
blanks<-full_data%>%
  filter(type=="blank")%>%
  group_by(date, plate, timepoint)%>%
  summarise(mean_blank=mean(fluorescence.norm));blanks
```

View summarized blank data. 

```{r}
blanks%>%
  ggplot(aes(x=timepoint, y=mean_blank))+
  facet_wrap(~date*plate)+
  geom_point()+
  theme_classic()
```

Subtract blank values from fluorescence values for oysters. 

```{r}
full_data<-left_join(full_data, blanks)

full_data<-full_data%>%
  filter(!type=="blank")%>%
  mutate(fluorescence.corr=fluorescence.norm-mean_blank)
```

Plot again. 

```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=fluorescence.corr, colour=family, group=interaction(date, well, plate)))+
  facet_wrap(~date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=fluorescence.corr, colour=length.mm, group=interaction(date, well, plate)))+
  facet_wrap(~date)+
  scale_colour_gradient(low="darkblue", high="red")+
  geom_point()+
  geom_line()+
  theme_classic()
```

Size normalize data.
```{r}
#normalize by length
full_data<-full_data%>%
  mutate(fluorescence.corr.mm=fluorescence.corr/length.mm)
```

Plot again. 

Plot by area normalized. 
```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=fluorescence.corr.mm, colour=family, group=interaction(date, well, plate)))+
  facet_wrap(~date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Plot by area normalized colored by size. 
```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=fluorescence.corr.mm, colour=length.mm, group=interaction(date, well, plate)))+
  facet_wrap(~date)+
  scale_colour_gradient(low="darkblue", high="red")+
  geom_point()+
  geom_line()+
  theme_classic()
```

Remove unnecessary columns. 

```{r}
str(full_data)

full_data<-full_data%>%
  #select(!resazurin_counts)%>%
  select(!type)%>%
  select(!mean_blank)
  #select(!length.mm)%>%
  #select(!fluorescence.corr)%>%
  #select(!fluorescence.norm)

str(full_data)

full_data<-full_data%>%
  rename(value=fluorescence.corr.mm)
```

### Remove oversaturated samples 

Remove any sample that reached > 2800 raw value at any point during the trials, these were over saturated and data is unreliable. 

```{r}
full_data%>%
  filter(resazurin_counts>3000)%>%
  group_by(date, plate, well)%>%
  mutate(unique=paste(date, plate, well))

#there are 150 samples that went above the threshold

list<-full_data%>%
  filter(resazurin_counts>3000)%>%
  group_by(date, plate, well)%>%
  mutate(unique=paste(date, plate, well))%>%
  pull(unique)%>%
  unique()
```

Remove the 155 samples that exceeded the threshold of 2800 sometime during the trial. 

```{r}
full_data<-full_data%>%
  mutate(unique=paste(date, plate, well))%>%
  filter(!unique %in% list)
```

## Models and Plots - by family 

Plot individual data. 
```{r}
plot1<-full_data%>%
  ggplot(aes(x=timepoint, y=value, colour=family, group=interaction(date, family, plate, well)))+
  facet_wrap(~date)+
  geom_point()+
  geom_line()+
  theme_classic();plot1

ggsave(plot1, filename="figures/trials/individual_trajectories.png", width=8, height=8, units="in")
```

Run a model on metabolic rates. 

Add date when we have multiple dates. 

```{r}
model<-full_data%>%
  lmer((value)^(1/3) ~ family * timepoint + (1|well:plate) + (1|plate), data=.)

anova(model)
summary(model)
qqPlot(residuals(model))
```

Plot as a model for each family at each temperature. 

```{r}
plot2<-full_data%>%
  ggplot(aes(x=timepoint, y=value, colour=family, group=interaction(date, family, temperature)))+
  facet_wrap(~family)+
  geom_smooth(stat="smooth")+
  theme_classic();plot2

ggsave(plot2, filename="figures/trials/family_trajectories.png", width=12, height=12, units="in")

plot2b<-full_data%>%
  ggplot(aes(x=timepoint, y=value, colour=phenotype, group=interaction(date, family, temperature)))+
  stat_smooth(geom="smooth", method="loess", se=FALSE)+
  theme_classic();plot2b
```

## Models and Plots - by phenotype 

Plot raw data. 
```{r}
plot1a<-full_data%>%
  ggplot(aes(x=timepoint, y=value, colour=phenotype, group=interaction(date, phenotype, plate, well)))+
  facet_wrap(~date)+
  geom_point()+
  geom_line()+
  theme_classic();plot1a

ggsave(plot1a, filename="figures/trials/individual_trajectories_phenotype.png", width=8, height=8, units="in")
```

Run a model on metabolic rates. 

Add date when we have multiple dates. 

```{r}
model<-full_data%>%
  lmer((value)^(1/3) ~ timepoint * phenotype + (1|well:plate) + (1|plate) + (1|family), data=.)

anova(model)
summary(model)
qqPlot(residuals(model))
```

Plot as a model for each phenotype. 

```{r}
plot2a<-full_data%>%
  ggplot(aes(x=timepoint, y=value, colour=phenotype, group=interaction(date, phenotype)))+
  stat_smooth(geom="smooth", method="loess")+
  theme_classic();plot2a

ggsave(plot2a, filename="figures/trials/phenotype_trajectories.png", width=12, height=12, units="in")
```

## Calculate change in fluorescence between each timepoint 

Convert to wide format and calculate.  

```{r}
data_wide <- full_data %>%
  select(date, plate, well, family, timepoint, phenotype, value)%>%
  pivot_wider(names_from = timepoint, values_from = value)

deltas <- data_wide %>%
  mutate(
    delta_T0_T1 = `1` - `0`,
    delta_T1_T2 = `2` - `1`,
    delta_T2_T3 = `3` - `2`,
    delta_T3_T4 = `4` - `3`
  )
```

Convert back to long format. 

```{r}
deltas_long<-deltas%>%
  pivot_longer(names_to = "delta", values_to = "change", cols=c(delta_T0_T1:delta_T3_T4))
```

Plot deltas for each family. 

Plot all together 
```{r}
plot4<-deltas_long%>%
  ggplot(aes(x=delta, y=change, colour=family))+
  facet_wrap(~date)+
  geom_violin()+
  theme_classic();plot4

plot4a<-deltas_long%>%
  ggplot(aes(x=delta, y=change, colour=phenotype))+
  facet_wrap(~date)+
  geom_violin()+
  theme_classic();plot4a
```

T0-T1 

```{r}
plot5<-deltas%>%
  ggplot(aes(x=family, y=delta_T0_T1, colour=family, group=interaction(date, family)))+
  geom_violin()+
  theme_classic();plot5

plot5a<-deltas%>%
  ggplot(aes(x=phenotype, y=delta_T0_T1, colour=phenotype, group=interaction(date, family)))+
  geom_violin()+
  theme_classic();plot5a
```

T1-T2 

```{r}
plot6<-deltas%>%
  ggplot(aes(x=family, y=delta_T1_T2, colour=family, group=interaction(date, family)))+
  geom_violin()+
  theme_classic();plot6

plot6a<-deltas%>%
  ggplot(aes(x=phenotype, y=delta_T1_T2, colour=phenotype, group=interaction(date, family)))+
  geom_violin()+
  theme_classic();plot6a
```

T2-T3 

```{r}
plot6<-deltas%>%
  ggplot(aes(x=family, y=delta_T2_T3, colour=family, group=interaction(date, family)))+
  geom_violin()+
  theme_classic();plot6

plot6a<-deltas%>%
  ggplot(aes(x=phenotype, y=delta_T2_T3, colour=phenotype, group=interaction(date, family)))+
  geom_violin()+
  theme_classic();plot6a
```

T3-T4 

```{r}
plot7<-deltas%>%
  ggplot(aes(x=family, y=delta_T3_T4, colour=family, group=interaction(date, family)))+
  geom_violin()+
  theme_classic();plot7

plot7a<-deltas%>%
  ggplot(aes(x=phenotype, y=delta_T3_T4, colour=phenotype, group=interaction(date, family)))+
  geom_violin()+
  theme_classic();plot7a
```



## Calculate total change in fluorescence over the entire trial

Total fluorescence over the course of the trial is equivalent to the value at TP4 (all values start at 0).  
```{r}
end<-full_data%>%
  filter(timepoint=="4")
```

Plot total by family and phenotype. 

```{r}
plot9<-end%>%
  ggplot(aes(x=phenotype, y=value, colour=phenotype, group=interaction(date, family, temperature)))+
  geom_violin()+
  theme_classic();plot9

plot9a<-end%>%
  ggplot(aes(x=phenotype, y=value, colour=phenotype))+
  geom_violin(aes(fill=NULL))+
  geom_point(position=position_jitterdodge())+
  theme_classic();plot9a
```

```{r}
model<-end%>%
  lmer((value)^(1/3) ~ family + (1|plate), data=.)

anova(model)
summary(model)
qqPlot(residuals(model))

model<-end%>%
  lmer((value)^(1/3) ~ phenotype + (1|plate), data=.)

anova(model)
summary(model)
qqPlot(residuals(model))
```
